#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

base_domain="{{ base_domain_name }}"

common_services=()
services=$(aws autoscaling describe-auto-scaling-groups --query "AutoScalingGroups[? Tags[? (Key=='Category') && Value=='service']]".AutoScalingGroupName --output text)
for fullsvc in $services;do
  svc=$(echo $fullsvc | awk -F "-" '{print $2}')
  common_services+=($svc)
done
common_services=($(echo ${common_services[*]} | sed 's/ /\n/g' | sort | uniq))
#common_services=(acct admin api app auth bliss bms collab eos fixer gate imp notify orca plm pubmarket restapi scheduler sds trex workflow xray)

for svc in "${common_services[@]}"; do
  echo -n "$svc##"
  if [[ "${svc}" == "backstop" ]]; then
    continue
  else
    result=$(curl --connect-timeout 2 http://${svc}.priv.${base_domain}/SYSTEM/dbtest 2>/dev/null)
  fi
  echo ${result}
done | sed '/^$/d' | column -t -s '##' | while read -r line; do
  if [[ $(awk '{print $2}' <<< "$line") == "success" ]];then
    echo -e "${GREEN}${line}${NC}"
  elif [[ $(awk '{print $2}' <<< "$line") != "" ]]; then
    echo -e "${YELLOW}${line}${NC}"
  else
    echo -e "${RED}${line}${NC}"
  fi
done